Unit Service.UploadImage;

Interface

Uses
    System.SysUtils,
    System.Classes,
    System.Generics.Collections,
    MVCFramework.ActiveRecord,
    FireDAC.Comp.Client,
    Web.ReqFiles,
    Service.Interfaces;

Type
    TImageUploadService = Class(TInterfacedObject, IImageUploadService)
    Public
        Function SaveUploadedImages(Const AFiles: TWebRequestFiles; Const AUserID: String): Boolean;
    End;

Implementation

Uses
    System.IOUtils,
    System.DateUtils,
    System.Math,
    System.StrUtils,
    MVCFramework.Logger,
    FireDac.Stan.Param,
    Data.DB,
    Graphics;

{ TImageUploadService }

//________________________________________________________________________________________
Function TImageUploadService.SaveUploadedImages(
    Const AFiles: TWebRequestFiles; Const AUserID: String): Boolean;
Var
    i, j: Integer;
    LConn: TFDConnection;
    LQuery: TFDQuery;
    LGUIDFile, LFileExt, LSavedFileName, LSavedFullPath: String;
    LBaseUploadsDir: String;
    LTempFiles: TStringList;
    LUploadedIDs: TList<Int64>;
    LBranchIDs: TList<Int64>;
    LMem: TMemoryStream;
    LFileSizeKB: Integer;
    LOrigName, LContentType: String;
    LImagePhoneID: Int64;

    LBitmap: TBitmap;
    LWidth, LHeight: Integer;

    // variables for distribution
    BranchCounts: TDictionary<Int64, Integer>;
    minBranchID: Int64;
    minCount, cnt: Integer;

    Function GetLastInsertID: Int64;
    Begin
        // این تابع برای MySQL نوشته شده است.
        LQuery.SQL.Text := 'SELECT LAST_INSERT_ID() AS id';
        LQuery.Open;
        Try
            Result := LQuery.FieldByName('id').AsLargeInt;
        Finally
            LQuery.Close;
        End;
    End;

Begin
    Result := False;

    If (AFiles = Nil) Or (AFiles.Count = 0) Then
        Exit;

    // مسیر ذخیره کنار exe: /uploads/
    LBaseUploadsDir := TPath.Combine(ExtractFilePath(ParamStr(0)), 'uploads');
    If Not TDirectory.Exists(LBaseUploadsDir) Then
        TDirectory.CreateDirectory(LBaseUploadsDir);

    LTempFiles := TStringList.Create;
    LUploadedIDs := TList<Int64>.Create;
    LBranchIDs := TList<Int64>.Create;
    LQuery := TFDQuery.Create(Nil);
    LMem := Nil;
    LBitmap := Nil;
    BranchCounts := Nil;

    Try
        Try
            LConn := TMVCActiveRecord.CurrentConnection As TFDConnection;
            If LConn = Nil Then
                Raise Exception.Create('ارتباط با دیتابیس برقرار نیست');

            LConn.StartTransaction;

            // -----------------------------
            //  ذخیره فایل‌ها و درج در customer_assign_image_phone
            // -----------------------------
            For i := 0 To AFiles.Count - 1 Do
            Begin
                LOrigName := AFiles.Items[i].FileName;
                LContentType := AFiles.Items[i].ContentType;

                If Not Assigned(AFiles.Items[i].Stream) Then
                    Raise Exception.CreateFmt('فایل %s استریم ندارد - قابلیت خواندن استریم پشتیبانی نشده', [LOrigName]);

                LMem := TMemoryStream.Create;
                Try
                    AFiles.Items[i].Stream.Position := 0;
                    LMem.CopyFrom(AFiles.Items[i].Stream, AFiles.Items[i].Stream.Size);

                    // تولید GUID اختصاصی برای هر فایل و ساخت نام ذخیره‌شده
                    LGUIDFile := TGUID.NewGuid.ToString; // 36 کاراکتر
                    LFileExt := ExtractFileExt(LOrigName);
                    If LFileExt = '' Then
                        LFileExt := '.bin';
                    LSavedFileName := LGUIDFile + LFileExt;
                    LSavedFullPath := TPath.Combine(LBaseUploadsDir, LSavedFileName);

                    // ذخیره فایل در پوشه مشترک uploads
                    LMem.Position := 0;
                    LMem.SaveToFile(LSavedFullPath);
                    LTempFiles.Add(LSavedFullPath);

                    // اندازه فایل به KB
                    LFileSizeKB := Ceil(TFile.GetSize(LSavedFullPath) / 1024);

                    // تلاش برای خواندن عرض/ارتفاع (در صورت امکان)
                    LWidth := 0;
                    LHeight := 0;
                    Try
                        LBitmap := TBitmap.Create;
                        Try
                            LBitmap.LoadFromFile(LSavedFullPath);
                            LWidth := LBitmap.Width;
                            LHeight := LBitmap.Height;
                        Finally
                            FreeAndNil(LBitmap);
                        End;
                    Except
                        LWidth := 0;
                        LHeight := 0;
                    End;

                    // درج رکورد در customer_assign_image_phone
                    // توجه: ImageGuid اکنون GUID فایل (LGUIDFile) است
                    LQuery.Connection := LConn;
                    LQuery.SQL.Text :=
                      'INSERT INTO customer_assign_image_phone (ImageGuid, UploadDate, FileSizeKB, ContentType, OriginalFileName, Width, Height) ' +
                      'VALUES (:g, :ud, :fs, :ct, :on, :w, :h)';

                    LQuery.ParamByName('g').AsString := LGUIDFile;
                    LQuery.ParamByName('ud').AsDateTime := Now;
                    LQuery.ParamByName('fs').AsInteger := LFileSizeKB;
                    LQuery.ParamByName('ct').AsString := LContentType;
                    LQuery.ParamByName('on').AsString := LOrigName;
                    LQuery.ParamByName('w').AsInteger := LWidth;
                    LQuery.ParamByName('h').AsInteger := LHeight;

                    LQuery.ExecSQL;

                    // گرفتن ID آخرین درج (MySQL)
                    LImagePhoneID := GetLastInsertID;
                    LUploadedIDs.Add(LImagePhoneID);

                Finally
                    FreeAndNil(LMem);
                End;
            End;

            // -----------------------------
            //  دریافت BranchID ها
            // -----------------------------
            LQuery.SQL.Text := 'SELECT BranchID FROM branch_branch ORDER BY BranchID';
            LQuery.Open;
            Try
                While Not LQuery.Eof Do
                Begin
                    LBranchIDs.Add(LQuery.FieldByName('BranchID').AsLargeInt);
                    LQuery.Next;
                End;
            Finally
                LQuery.Close;
            End;

            If LBranchIDs.Count = 0 Then
                Raise Exception.Create('هیچ شاخه‌ای برای تخصیص یافت نشد');

            // -----------------------------
            //  محاسبه تعداد فعلی Assignmentهایی که ImagePhoneID دارند و SourceCollectingDataID = 4
            //  (برای هر BranchID)
            // -----------------------------
            BranchCounts := TDictionary<Int64, Integer>.Create;
            Try
                For j := 0 To LBranchIDs.Count - 1 Do
                Begin
                    LQuery.SQL.Text := 'SELECT COUNT(*) AS cnt FROM customer_assignment ' +
                                       'WHERE BranchID = :b AND ImagePhoneID IS NOT NULL AND SourceCollectingDataID = 4';
                    LQuery.ParamByName('b').AsLargeInt := LBranchIDs[j];
                    LQuery.Open;
                    Try
                        cnt := LQuery.FieldByName('cnt').AsInteger;
                    Finally
                        LQuery.Close;
                    End;
                    BranchCounts.AddOrSetValue(LBranchIDs[j], cnt);
                End;

                // -----------------------------
                //  پخش تصاویر: برای هر تصویر شعبه‌ای که کمترین cnt دارد انتخاب می‌شود
                // -----------------------------
                For j := 0 To LUploadedIDs.Count - 1 Do
                Begin
                    // پیدا کردن شعبه با کمترین مقدار
                    minCount := MaxInt;
                    minBranchID := 0;
                    For i := 0 To LBranchIDs.Count - 1 Do
                    Begin
                        If Not BranchCounts.TryGetValue(LBranchIDs[i], cnt) Then
                            cnt := 0;
                        If cnt < minCount Then
                        Begin
                            minCount := cnt;
                            minBranchID := LBranchIDs[i];
                        End;
                    End;

                    If minBranchID = 0 Then
                        minBranchID := LBranchIDs[0];

                    // درج نگاشت (ImagePhoneID -> BranchID)
                    LQuery.SQL.Text := 'INSERT INTO customer_assign_image_phone_branch (ImagePhoneID, BranchID) VALUES (:img, :br)';
                    LQuery.ParamByName('img').AsLargeInt := LUploadedIDs[j];
                    LQuery.ParamByName('br').AsLargeInt := minBranchID;
                    LQuery.ExecSQL;

                    // افزایش شمارش آن شاخه برای توازن بقیه تصاویر
                    If BranchCounts.TryGetValue(minBranchID, cnt) Then
                        BranchCounts.AddOrSetValue(minBranchID, cnt + 1)
                    Else
                        BranchCounts.AddOrSetValue(minBranchID, 1);
                End;

            Finally
                BranchCounts.Free;
            End;

            // -----------------------------
            //  پایان و Commit
            // -----------------------------
            LConn.Commit;
            Result := True;

        Except
            On E: Exception Do
            Begin
                // rollback و پاکسازی فایل‌های محلی
                Try
                    If Assigned(LConn) And LConn.InTransaction Then
                        LConn.Rollback;
                Except
                End;

                Try
                    For i := 0 To LTempFiles.Count - 1 Do
                        If TFile.Exists(LTempFiles[i]) Then
                            TFile.Delete(LTempFiles[i]);
                Except
                End;

                // حذف رکوردهای دیتابیس در صورت نیاز انجام نشد (تراکنش rollback شده)
                Raise;
            End;
    Finally
        LTempFiles.Free;
        LUploadedIDs.Free;
        LBranchIDs.Free;
        FreeAndNil(LQuery);
    End;
End;
//________________________________________________________________________________________

End.

