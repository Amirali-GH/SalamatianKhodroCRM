Unit Controller.Upload;

Interface

Uses
    System.JSON,
    MVCFramework,
    MVCFramework.Commons,
    MVCFramework.SQLGenerators.MSSQL,
    MVCFramework.ActiveRecord,
    MVCFramework.Nullables,
    FireDAC.Phys.MSSQL,
    System.Variants,
    System.Generics.Collections,
    Model.User,
    IdHash,
    Service.Interfaces,
    WebModule.SalamtCRM;

Type
    [MVCPath(BASE_API_V1 + '/upload')]
    TUploadFileController = class(TMVCController)
    Public
        [MVCPath('/salesconsultant/sheet')]
        [MVCHTTPMethods([httpPost])]
        [MVCConsumes(TMVCMediaType.MULTIPART_FORM_DATA)]
        Procedure GetSeperateSheet(Const [MVCInject] AUploadFileService: IUploadFileService);
End;

Implementation

Uses
    Web.ReqFiles,
    System.SysUtils,
    System.Classes,
    MVCFramework.Logger;

{ TUserController }

//________________________________________________________________________________________
Procedure TUploadFileController.GetSeperateSheet(Const AUploadFileService: IUploadFileService);
Var
    LStream: TStream;
    LFileName: String;
Begin
    If (Context.Request.Files.Count = 0) then
    Begin
        raise EMVCException.Create(HTTP_STATUS.NoContent, 'هیچ فایلی آپلود نشده است');
    End;

    LStream := Context.Request.Files[0].Stream;
    If not Assigned(LStream) then
    Begin
        raise EMVCException.Create(HTTP_STATUS.NoContent, 'استریم فایل خالی است');
    End;

    Try
        LStream.Position := 0;
        LFileName := Context.Request.Files[0].FileName;
        If AUploadFileService.GetSalesConsultantSheet(TStream(Context.Request.Files[0])) then
        Begin
            Render(HTTP_STATUS.OK, 'فایل با موفقیت ذخیره شد');
        End
        Else
        Begin
            raise EMVCException.Create(HTTP_STATUS.InternalServerError, 'ذخیره‌سازی فایل با مشکل مواجه شد');
        End;
    Except
        On E: EMVCException do raise;
        On E: Exception do
        Begin
          raise EMVCException.CreateFmt(HTTP_STATUS.InternalServerError, 'خطا در پردازش فایل: %s', [E.Message]);
        End;
    End;

End;
//________________________________________________________________________________________

End.
