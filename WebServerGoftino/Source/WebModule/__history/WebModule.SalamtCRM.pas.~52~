Unit WebModule.SalamtCRM;

Interface

Uses
    IdHashSHA,
    System.SysUtils,
    System.Classes,
    Web.HTTPApp,
    MVCFramework,
    UAuthCriteria,
    MVCFramework.Container,
    MVCFramework.Swagger.Commons;

Const
    BASE_API_V1 = '/api/v1';
Type
    TWMSalamtCustomer = class(TWebModule)
        procedure WebModuleCreate(Sender: TObject);
        procedure WebModuleDestroy(Sender: TObject);

    Private
        fMVC: TMVCEngine;
        procedure StaticFilesRules(const Context: TWebContext; var PathInfo: String;
          var Handled: Boolean);
    End;


var
  WebModuleClass: TComponentClass = TWMSalamtCustomer;

  Function HashPassword(const PlainPassword: string): string;

implementation

{$R *.dfm}


Uses
    IdGlobal,
    Controller.User,
    System.IOUtils,
    MVCFramework.JWT,
    MVCFramework.Commons,
    MVCFramework.Middleware.ActiveRecord,
    MVCFramework.Middleware.Session,
    MVCFramework.Middleware.Redirect,
    MVCFramework.Middleware.StaticFiles,
    MVCFramework.Middleware.Analytics,
    MVCFramework.Middleware.Trace,
    MVCFramework.Middleware.CORS,
    MVCFramework.Middleware.ETag,
    MVCFramework.Middleware.JWT,
    MVCFramework.Middleware.Compression;

Procedure TWMSalamtCustomer.WebModuleCreate(Sender: TObject);
Var
    WWWPath: string;
Begin
    fMVC := TMVCEngine.Create(Self,
      procedure(Config: TMVCConfig)
      begin
        //default content-type
        Config[TMVCConfigKey.DefaultContentType] := dotEnv.Env('dmvc.default.content_type', TMVCConstants.DEFAULT_CONTENT_TYPE);
        //default content charset
        Config[TMVCConfigKey.DefaultContentCharset] := dotEnv.Env('dmvc.default.content_charset', TMVCConstants.DEFAULT_CONTENT_CHARSET);
        //unhandled actions are permitted?
        Config[TMVCConfigKey.AllowUnhandledAction] := dotEnv.Env('dmvc.allow_unhandled_actions', 'false');
        //enables or not system controllers loading (available only from localhost requests)
        Config[TMVCConfigKey.LoadSystemControllers] := dotEnv.Env('dmvc.load_system_controllers', 'true');
        //default view file extension
        Config[TMVCConfigKey.DefaultViewFileExtension] := dotEnv.Env('dmvc.default.view_file_extension', 'html');
        //view path
        Config[TMVCConfigKey.ViewPath] := dotEnv.Env('dmvc.view_path', 'templates');
        //use cache for server side views (use "false" in debug and "true" in production for faster performances
        Config[TMVCConfigKey.ViewCache] := dotEnv.Env('dmvc.view_cache', 'false');
        //Max Record Count for automatic Entities CRUD
        Config[TMVCConfigKey.MaxEntitiesRecordCount] := dotEnv.Env('dmvc.max_entities_record_count', IntToStr(TMVCConstants.MAX_RECORD_COUNT));
        //Enable Server Signature in response
        Config[TMVCConfigKey.ExposeServerSignature] := dotEnv.Env('dmvc.expose_server_signature', 'false');
        //Enable X-Powered-By Header in response
        Config[TMVCConfigKey.ExposeXPoweredBy] := dotEnv.Env('dmvc.expose_x_powered_by', 'true');
        // Max request size in bytes
        Config[TMVCConfigKey.MaxRequestSize] := dotEnv.Env('dmvc.max_request_size', IntToStr(TMVCConstants.DEFAULT_MAX_REQUEST_SIZE));
      end);

    // Controllers
    fMVC.AddController(TUserController);
    // Controllers - END

    // Middleware
    // To use memory session uncomment the following line
    // fMVC.AddMiddleware(UseMemorySessionMiddleware);
    //
    // To use file based session uncomment the following line
    // fMVC.AddMiddleware(UseFileSessionMiddleware);
    //
    // To use database based session uncomment the following lines,
    // configure you firedac db connection and create table dmvc_sessions
    // fMVC.AddMiddleware(TMVCActiveRecordMiddleware.Create('firedac_con_def_name'));
    // fMVC.AddMiddleware(UseDatabaseSessionMiddleware);
    fMVC.AddMiddleware(TMVCAnalyticsMiddleware.Create(GetAnalyticsDefaultLogger));
    fMVC.AddMiddleware(TMVCTraceMiddleware.Create);
    fMVC.AddMiddleware(TMVCCompressionMiddleware.Create);

    fMVC.AddMiddleware(TMVCActiveRecordMiddleware.Create(
        dotEnv.Env('firedac.connection_definition_name', ''),
        dotEnv.Env('firedac.connection_definitions_filename', '')
    ));

    Var lConfigClaim : TJWTClaimsSetup;
    lConfigClaim :=
        procedure(Const JWT: TJWT)
        begin
            JWT.Claims.Issuer := 'MyApp';
            JWT.Claims.ExpirationTime := Now + EncodeTime(1, 0, 0, 0);          // سایر تنظیمات دلخواه...
        end;

    fMVC.AddMiddleware(
      TMVCJWTAuthenticationMiddleware.Create(
        TAuthCriteria.Create,
        lConfigClaim,
        True,
        '/logooff',
        dotEnv.Env('dmvc.secret_key'),
        '/api/login',
        [TJWTCheckableClaim.ExpirationTime],
        300,
        'HS256'
      )
    );


    WWWPath := TPath.Combine(TDirectory.GetCurrentDirectory, 'WWW');

    fMVC.AddMiddleware(TMVCStaticFilesMiddleware.Create(
        '/app',
        WWWPath,
        'index.html',
        False,
        'UTF-8',
        StaticFilesRules
    ));

    fMVC.AddMiddleware(TMVCStaticFilesMiddleware.Create(
        '/assets/favicon.ico',
        TPath.Combine(WWWPath, 'assets', 'favicon.ico'),
        'favicon.ico',
        False,
        'UTF-8',
        StaticFilesRules
    ));
    // Middleware - END

End;
//______________________________________________________________________________
Procedure TWMSalamtCustomer.StaticFilesRules(const Context: TWebContext; var PathInfo: String; Var Handled: Boolean);
Begin
    Handled := True;
    Context.Response.CustomHeaders.Values['Cache-Control'] := 'public, max-age=10';
End;
//______________________________________________________________________________
Procedure TWMSalamtCustomer.WebModuleDestroy(Sender: TObject);
Begin
    fMVC.Free;
End;
//________________________________________________________________________________________
Function HashPassword(const PlainPassword: string): string;
Var
    SHA1: TIdHashSHA1;
Begin
    SHA1 := TIdHashSHA1.Create;
    Try
        Result := SHA1.HashStringAsHex(
          PlainPassword,
          IndyTextEncoding_UTF8
          {$IFDEF STRING_IS_ANSI}, IndyTextEncoding_UTF8{$ENDIF}
        );
    Finally
      SHA1.Free;
    End;
End;
//______________________________________________________________________________

end.
